<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Metra Commuter</title>
	<base href="/" />
	<link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
	<link rel="stylesheet" href="css/app.css" />
	<link rel="icon" type="image/png" href="favicon.png" />
	<link href="PwaCopilotDemo.styles.css" rel="stylesheet" />
	<link href="manifest.webmanifest" rel="manifest" />
	<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
	<link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
	<!-- Preload Blazor runtime so download starts while CSS and other resources load -->
	<link rel="preload" href="_framework/blazor.webassembly.js" as="script" />
	<script>
		// Function to get user location and store it
		window.getUserLocation = function() {
			return new Promise((resolve, reject) => {
				// Default coordinates (Chicago area)
				const defaultLocation = {
					latitude: 41.88206675125365,
					longitude: -87.62781589291926
				};
				
				if (!navigator.geolocation) {
					console.warn("Geolocation is not supported. Using default location.");
					localStorage.setItem('userLocation', JSON.stringify(defaultLocation));
					resolve(defaultLocation);
					return;
				}
				
				navigator.geolocation.getCurrentPosition(
					position => {
						const location = {
							latitude: position.coords.latitude,
							longitude: position.coords.longitude
						};
						localStorage.setItem('userLocation', JSON.stringify(location));
						resolve(location);
					},
					error => {
						console.error("Error getting location:", error.message);
						console.warn("Using default location due to error.");
						localStorage.setItem('userLocation', JSON.stringify(defaultLocation));
						resolve(defaultLocation);
					},
					{
						enableHighAccuracy: true,
						timeout: 10000,
						maximumAge: 300000 // 5 minutes
					}
				);
			});
		};
		
		// Function to get stored location or null if not available
		window.getStoredLocation = function() {
			const locationData = localStorage.getItem('userLocation');
			return locationData ? JSON.parse(locationData) : null;
		};
	</script>
</head>

<body>
	<div id="app">
		<svg class="loading-progress">
			<circle r="40%" cx="50%" cy="50%" />
			<circle r="40%" cx="50%" cy="50%" />
		</svg>
		<div class="loading-progress-text"></div>
	</div>

	<div id="blazor-error-ui">
		An unhandled error has occurred.
		<a href="." class="reload">Reload</a>
		<span class="dismiss">ðŸ—™</span>
	</div>
	<script src="_framework/blazor.webassembly.js"></script>
	<script>
		// Enhanced service worker registration with update detection
		if ('serviceWorker' in navigator) {
			window.addEventListener('load', () => {
				navigator.serviceWorker.register('service-worker.js', { updateViaCache: 'none' })
					.then(registration => {
						console.log('Service Worker registered:', registration);
						
						// Check for updates immediately and then every 60 seconds
						registration.update();
						setInterval(() => {
							console.log('Checking for service worker updates...');
							registration.update();
						}, 60000);
						
						// Listen for updates
						registration.addEventListener('updatefound', () => {
							const newWorker = registration.installing;
							console.log('Service Worker update found');
							
							newWorker.addEventListener('statechange', () => {
								if (newWorker.state === 'activated') {
									// Check if there's a controller (an old service worker)
									if (navigator.serviceWorker.controller) {
										console.log('New service worker activated - reloading page');
										// Show a notification to the user
										showUpdateNotification();
									}
								}
							});
						});
					})
					.catch(error => {
						console.error('Service Worker registration failed:', error);
					});
				
				// Listen for controllerchange event - fired when a new service worker takes control
				navigator.serviceWorker.addEventListener('controllerchange', () => {
					// Only reload if we're not already showing the notification
					if (!document.getElementById('sw-update-notification')) {
						console.log('Service Worker controller changed - reloading page');
						window.location.reload();
					}
				});
			});
		}
		
		function showUpdateNotification() {
			// Check if notification already exists
			if (document.getElementById('sw-update-notification')) return;
			
			const notification = document.createElement('div');
			notification.id = 'sw-update-notification';
			notification.style.cssText = `
				position: fixed;
				top: 20px;
				left: 50%;
				transform: translateX(-50%);
				background: #0052a7;
				color: white;
				padding: 16px 24px;
				border-radius: 8px;
				box-shadow: 0 4px 12px rgba(0,0,0,0.3);
				z-index: 10000;
				display: flex;
				align-items: center;
				gap: 16px;
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
			`;
			
			notification.innerHTML = `
				<div>
					<strong>Update Available</strong>
					<p style="margin: 4px 0 0 0; font-size: 14px;">A new version of the app is available with the latest schedule data.</p>
				</div>
				<button id="sw-update-reload" style="
					background: white;
					color: #0052a7;
					border: none;
					padding: 8px 16px;
					border-radius: 4px;
					font-weight: bold;
					cursor: pointer;
					white-space: nowrap;
				">Reload Now</button>
			`;
			
			document.body.appendChild(notification);
			
			document.getElementById('sw-update-reload').addEventListener('click', () => {
				window.location.reload();
			});
			
			// Auto-reload after 10 seconds if user doesn't click
			setTimeout(() => {
				window.location.reload();
			}, 10000);
		}
	</script>
	
	<script>
		window.scrollToTableRow = function (rowIndex) {
			setTimeout(() => {
				const tableContainer = document.querySelector('.table-container');
				if (!tableContainer) return;

				const rows = tableContainer.querySelectorAll('tbody tr');
				if (rowIndex >= 0 && rowIndex < rows.length) {
					const targetRow = rows[rowIndex];
					const headerHeight = tableContainer.querySelector('thead').offsetHeight || 0;

					// Scroll the container manually to position the row at the top (accounting for header)
					tableContainer.scrollTop = targetRow.offsetTop - headerHeight;
				}
			}, 100); // Small delay to ensure table is rendered
		};
	</script>
</body>

</html>
